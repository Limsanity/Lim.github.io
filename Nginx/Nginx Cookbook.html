<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx Cookbook | Lim&#39;s Page</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/zelda.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" sizes="192x192" href="/zelda-192.png">
    <meta name="description" content="something about front-end">
    
    <link rel="preload" href="/assets/css/0.styles.8de41c91.css" as="style"><link rel="preload" href="/assets/js/app.750feb0e.js" as="script"><link rel="preload" href="/assets/js/2.51f79b28.js" as="script"><link rel="preload" href="/assets/js/44.65ed8576.js" as="script"><link rel="preload" href="/assets/js/10.c677f95a.js" as="script"><link rel="prefetch" href="/assets/js/100.177f514a.js"><link rel="prefetch" href="/assets/js/101.bd0c4e7f.js"><link rel="prefetch" href="/assets/js/102.cadfa153.js"><link rel="prefetch" href="/assets/js/103.2706f2ae.js"><link rel="prefetch" href="/assets/js/104.59af27a1.js"><link rel="prefetch" href="/assets/js/105.6a8045bd.js"><link rel="prefetch" href="/assets/js/106.bd6e128c.js"><link rel="prefetch" href="/assets/js/107.e8ec64a4.js"><link rel="prefetch" href="/assets/js/108.48c5b40e.js"><link rel="prefetch" href="/assets/js/109.1f3ecd2d.js"><link rel="prefetch" href="/assets/js/11.da07f57e.js"><link rel="prefetch" href="/assets/js/110.59ab3d87.js"><link rel="prefetch" href="/assets/js/111.6e505792.js"><link rel="prefetch" href="/assets/js/112.6805675b.js"><link rel="prefetch" href="/assets/js/113.8351e89e.js"><link rel="prefetch" href="/assets/js/114.f8ae045e.js"><link rel="prefetch" href="/assets/js/12.e3689742.js"><link rel="prefetch" href="/assets/js/13.b519f9a3.js"><link rel="prefetch" href="/assets/js/14.53eebcd6.js"><link rel="prefetch" href="/assets/js/15.1d4304e2.js"><link rel="prefetch" href="/assets/js/16.949c7023.js"><link rel="prefetch" href="/assets/js/17.1ebb059b.js"><link rel="prefetch" href="/assets/js/18.70936c5f.js"><link rel="prefetch" href="/assets/js/19.60e280c9.js"><link rel="prefetch" href="/assets/js/20.acc3b53c.js"><link rel="prefetch" href="/assets/js/21.000f9bfe.js"><link rel="prefetch" href="/assets/js/22.dde14540.js"><link rel="prefetch" href="/assets/js/23.91dc37f8.js"><link rel="prefetch" href="/assets/js/24.3356f787.js"><link rel="prefetch" href="/assets/js/25.5aad8683.js"><link rel="prefetch" href="/assets/js/26.147bad61.js"><link rel="prefetch" href="/assets/js/27.d6e6818f.js"><link rel="prefetch" href="/assets/js/28.89264090.js"><link rel="prefetch" href="/assets/js/29.6fa2b213.js"><link rel="prefetch" href="/assets/js/3.e7a2c18f.js"><link rel="prefetch" href="/assets/js/30.0d23825c.js"><link rel="prefetch" href="/assets/js/31.6a3ff0b7.js"><link rel="prefetch" href="/assets/js/32.ee5614c3.js"><link rel="prefetch" href="/assets/js/33.8b077b7f.js"><link rel="prefetch" href="/assets/js/34.2d88a808.js"><link rel="prefetch" href="/assets/js/35.f1eb02ae.js"><link rel="prefetch" href="/assets/js/36.77d7adb2.js"><link rel="prefetch" href="/assets/js/37.6775800c.js"><link rel="prefetch" href="/assets/js/38.fdd1253f.js"><link rel="prefetch" href="/assets/js/39.c62e28db.js"><link rel="prefetch" href="/assets/js/4.6c56feef.js"><link rel="prefetch" href="/assets/js/40.9054f4e2.js"><link rel="prefetch" href="/assets/js/41.e7b94d57.js"><link rel="prefetch" href="/assets/js/42.b1786a78.js"><link rel="prefetch" href="/assets/js/43.1580e7b7.js"><link rel="prefetch" href="/assets/js/45.36712ec7.js"><link rel="prefetch" href="/assets/js/46.1ccea627.js"><link rel="prefetch" href="/assets/js/47.13942b71.js"><link rel="prefetch" href="/assets/js/48.19830dcb.js"><link rel="prefetch" href="/assets/js/49.09aa6295.js"><link rel="prefetch" href="/assets/js/5.d17b0055.js"><link rel="prefetch" href="/assets/js/50.df95e7c1.js"><link rel="prefetch" href="/assets/js/51.beb07eea.js"><link rel="prefetch" href="/assets/js/52.f599e852.js"><link rel="prefetch" href="/assets/js/53.63bc005f.js"><link rel="prefetch" href="/assets/js/54.8fca02df.js"><link rel="prefetch" href="/assets/js/55.4add5831.js"><link rel="prefetch" href="/assets/js/56.e5bd1172.js"><link rel="prefetch" href="/assets/js/57.b0ef0d61.js"><link rel="prefetch" href="/assets/js/58.0a727eef.js"><link rel="prefetch" href="/assets/js/59.9bbd5c95.js"><link rel="prefetch" href="/assets/js/6.8308d385.js"><link rel="prefetch" href="/assets/js/60.c5256477.js"><link rel="prefetch" href="/assets/js/61.b2709925.js"><link rel="prefetch" href="/assets/js/62.7f88b67a.js"><link rel="prefetch" href="/assets/js/63.f45cc107.js"><link rel="prefetch" href="/assets/js/64.c2272af3.js"><link rel="prefetch" href="/assets/js/65.aa141d4c.js"><link rel="prefetch" href="/assets/js/66.1a0d0448.js"><link rel="prefetch" href="/assets/js/67.1f8281e9.js"><link rel="prefetch" href="/assets/js/68.4327c5c0.js"><link rel="prefetch" href="/assets/js/69.45c10907.js"><link rel="prefetch" href="/assets/js/7.25ac0485.js"><link rel="prefetch" href="/assets/js/70.3057e14c.js"><link rel="prefetch" href="/assets/js/71.5efe1e42.js"><link rel="prefetch" href="/assets/js/72.fc58a760.js"><link rel="prefetch" href="/assets/js/73.5d2dc328.js"><link rel="prefetch" href="/assets/js/74.08d8b949.js"><link rel="prefetch" href="/assets/js/75.f2bb48ad.js"><link rel="prefetch" href="/assets/js/76.96a4273b.js"><link rel="prefetch" href="/assets/js/77.d5877740.js"><link rel="prefetch" href="/assets/js/78.43c99cc0.js"><link rel="prefetch" href="/assets/js/79.bfce4a46.js"><link rel="prefetch" href="/assets/js/8.98216078.js"><link rel="prefetch" href="/assets/js/80.1a4d9abd.js"><link rel="prefetch" href="/assets/js/81.22561592.js"><link rel="prefetch" href="/assets/js/82.ba55ed12.js"><link rel="prefetch" href="/assets/js/83.97fdeadc.js"><link rel="prefetch" href="/assets/js/84.74bc54ee.js"><link rel="prefetch" href="/assets/js/85.86430dd5.js"><link rel="prefetch" href="/assets/js/86.746060ff.js"><link rel="prefetch" href="/assets/js/87.3a394a36.js"><link rel="prefetch" href="/assets/js/88.364afa36.js"><link rel="prefetch" href="/assets/js/89.b01f6f1b.js"><link rel="prefetch" href="/assets/js/9.2f45caf6.js"><link rel="prefetch" href="/assets/js/90.1b8e8891.js"><link rel="prefetch" href="/assets/js/91.1febf461.js"><link rel="prefetch" href="/assets/js/92.92378978.js"><link rel="prefetch" href="/assets/js/93.8fbfafa9.js"><link rel="prefetch" href="/assets/js/94.0cd4c971.js"><link rel="prefetch" href="/assets/js/95.7f7b8f77.js"><link rel="prefetch" href="/assets/js/96.87929228.js"><link rel="prefetch" href="/assets/js/97.87b1c656.js"><link rel="prefetch" href="/assets/js/98.eb84c7b1.js"><link rel="prefetch" href="/assets/js/99.b7d87337.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8de41c91.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Lim's Page</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博文" class="dropdown-title"><span class="title">博文</span> <span class="arrow down"></span></button> <button type="button" aria-label="博文" class="mobile-dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Web/" class="nav-link">
  Web
</a></li><li class="dropdown-item"><!----> <a href="/Web2/" class="nav-link">
  Web2
</a></li><li class="dropdown-item"><!----> <a href="/EnvironmentSetting/" class="nav-link">
  Environment Setting
</a></li><li class="dropdown-item"><!----> <a href="/Kubernetes/" class="nav-link">
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/Docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/Linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/Nginx/" class="nav-link router-link-active">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/Sentry/" class="nav-link">
  Sentry
</a></li><li class="dropdown-item"><!----> <a href="/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Limsanity" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博文" class="dropdown-title"><span class="title">博文</span> <span class="arrow down"></span></button> <button type="button" aria-label="博文" class="mobile-dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Web/" class="nav-link">
  Web
</a></li><li class="dropdown-item"><!----> <a href="/Web2/" class="nav-link">
  Web2
</a></li><li class="dropdown-item"><!----> <a href="/EnvironmentSetting/" class="nav-link">
  Environment Setting
</a></li><li class="dropdown-item"><!----> <a href="/Kubernetes/" class="nav-link">
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/Docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/Linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/Nginx/" class="nav-link router-link-active">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/Sentry/" class="nav-link">
  Sentry
</a></li><li class="dropdown-item"><!----> <a href="/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Limsanity" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Nginx Cookbook</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Nginx/Nginx%20Cookbook.html#high-performance-load-balancing" class="sidebar-link">High-Performance Load Balancing</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Nginx/Nginx%20Cookbook.html#http-load-balancing" class="sidebar-link">HTTP Load Balancing</a></li><li class="sidebar-sub-header"><a href="/Nginx/Nginx%20Cookbook.html#tcp-load-balancing" class="sidebar-link">TCP Load Balancing</a></li><li class="sidebar-sub-header"><a href="/Nginx/Nginx%20Cookbook.html#udp-load-balancing" class="sidebar-link">UDP Load Balancing</a></li><li class="sidebar-sub-header"><a href="/Nginx/Nginx%20Cookbook.html#load-balancing-methods" class="sidebar-link">Load-Balancing Methods</a></li><li class="sidebar-sub-header"><a href="/Nginx/Nginx%20Cookbook.html#sticky-cookie-nginx-plus" class="sidebar-link">Sticky Cookie（Nginx Plus）</a></li><li class="sidebar-sub-header"><a href="/Nginx/Nginx%20Cookbook.html#sticky-learn-nginx-plus" class="sidebar-link">Sticky Learn（Nginx Plus）</a></li><li class="sidebar-sub-header"><a href="/Nginx/Nginx%20Cookbook.html#sticky-routing-nginx-plus" class="sidebar-link">Sticky Routing（Nginx Plus）</a></li><li class="sidebar-sub-header"><a href="/Nginx/Nginx%20Cookbook.html#connection-draining-nginx-plus" class="sidebar-link">Connection Draining（Nginx Plus）</a></li><li class="sidebar-sub-header"><a href="/Nginx/Nginx%20Cookbook.html#passive-health-checks" class="sidebar-link">Passive Health Checks</a></li><li class="sidebar-sub-header"><a href="/Nginx/Nginx%20Cookbook.html#active-health-checks-nginx-plus" class="sidebar-link">Active Health Checks（Nginx Plus）</a></li><li class="sidebar-sub-header"><a href="/Nginx/Nginx%20Cookbook.html#slow-start" class="sidebar-link">Slow Start</a></li></ul></li><li><a href="/Nginx/Nginx%20Cookbook.html#traffic-management" class="sidebar-link">Traffic Management</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Nginx/Nginx%20Cookbook.html#a-b-testing" class="sidebar-link">A/B Testing</a></li><li class="sidebar-sub-header"><a href="/Nginx/Nginx%20Cookbook.html#using-the-geoip-module-and-database" class="sidebar-link">Using the GeoIP Module and Database</a></li><li class="sidebar-sub-header"><a href="/Nginx/Nginx%20Cookbook.html#restricting-access-based-on-country" class="sidebar-link">Restricting Access Based on Country</a></li><li class="sidebar-sub-header"><a href="/Nginx/Nginx%20Cookbook.html#finding-the-original-client" class="sidebar-link">Finding the Original Client</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx-cookbook"><a href="#nginx-cookbook" class="header-anchor">#</a> Nginx Cookbook</h1> <h2 id="high-performance-load-balancing"><a href="#high-performance-load-balancing" class="header-anchor">#</a> High-Performance Load Balancing</h2> <h3 id="http-load-balancing"><a href="#http-load-balancing" class="header-anchor">#</a> HTTP Load Balancing</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">upstream</span> backend <span class="token punctuation">{</span>
  <span class="token keyword">server</span> <span class="token number">10.10</span><span class="token number">.12</span><span class="token number">.45</span><span class="token punctuation">:</span><span class="token number">80</span>      weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">server</span> app<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">80</span>  weight<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>backend<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>HTTP upstream模块控制着HTTP的负载均衡，该模块可以定义一些目标地址，目标地址可以是Unix套接字，IP地址，DNS记录。</p> <h3 id="tcp-load-balancing"><a href="#tcp-load-balancing" class="header-anchor">#</a> TCP Load Balancing</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code>stream <span class="token punctuation">{</span>
  <span class="token keyword">upstream</span> mysql_read <span class="token punctuation">{</span>
    <span class="token keyword">server</span> read1<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">3306</span>  weight<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> read2<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">3306</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">10.10</span><span class="token number">.12</span><span class="token number">.34</span><span class="token punctuation">:</span><span class="token number">3306</span>        backup<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span> <span class="token number">3306</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_pass</span> mysql_read<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用Nginx的stream模块进行TCP负载均衡。该配置不应该放在<code>conf.d</code>文件夹下，<code>conf.d</code>文件夹下应当放置和http块相关的配置。可以新建一个<code>stream.confg.d</code>放置tcp相关的配置，然后在<code>nginx.conf</code>文件中新建stream块，include新的stream配置文件。</p> <p>该负载均衡配置和http相似，目标地址可以是Unix套接字、IP和DNS记录，以及可以配置服务器权重、最大连接数、DNS解析器和backup。</p> <h3 id="udp-load-balancing"><a href="#udp-load-balancing" class="header-anchor">#</a> UDP Load Balancing</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code>stream <span class="token punctuation">{</span>
  <span class="token keyword">upstream</span> ntp <span class="token punctuation">{</span>
    <span class="token keyword">server</span> ntp1<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">123</span>  weight<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> ntp2<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span> <span class="token number">123</span> udp<span class="token punctuation">;</span>
    <span class="token keyword">proxy_pass</span> ntp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>UDP负载均衡和TCP一样在stream块中配置，server块中指定监听UDP即可。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>stream <span class="token punctuation">{</span>
  <span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span> <span class="token number">1195</span> udp reuseport<span class="token punctuation">;</span>
    <span class="token keyword">proxy_pass</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">1194</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果需要在客户端和服务器间负载均衡多个包，可以指定<code>reuseport</code>提高效率，例如：OpenVPN、VoIP、DTLS等服务。</p> <h3 id="load-balancing-methods"><a href="#load-balancing-methods" class="header-anchor">#</a> Load-Balancing Methods</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">upstream</span> backend <span class="token punctuation">{</span>
  least_conn<span class="token punctuation">;</span>
  <span class="token keyword">server</span> backend<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
  <span class="token keyword">server</span> backend1<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Nginx提供了以下几种负载均衡的方法：</p> <p>Round robin</p> <ul><li>轮询。默认负载均衡的方法。可以为不同机器设置权重。</li></ul> <p>Least connections</p> <ul><li>最少连接数量。也可以为不同机器设置权重，选取connections/weight最小的服务器。启用指令为<code>least_conn</code>。</li></ul> <p>Least time</p> <ul><li>最低时延。只有Nginx Plus中可用。最少连接数量并不意味着最小响应时间。时延计算和<code>header</code>或者<code>last_byte</code>有关。如果指定为<code>header</code>，时延为接收到相应头部的时间；如果指定为<code>last_byte</code>，时延为收到整个响应的时间。启用指令为<code>least_time</code>。示例：<code>least_time header</code>。</li></ul> <p>Generic hash</p> <ul><li>一般哈希。允许用户自定义哈希函数的输入。注意，当一个上游服务器实例被删除时，所有请求将会被重新映射，可以使用<code>consistent</code>通过ketama算法减少重新分配的影响。启用指令<code>hash</code>。示例：<code>hash $redirect_uri consistent</code>。</li></ul> <p>Random</p> <ul><li>随机。会考虑权重。可以指定参数<code>two</code>，Nginx将随机选取两个服务器，然后根据制定算法进行选择，默认为<code>least_conn</code>。启用指令<code>random</code>。示例：<code>random two least_time=last_byte</code>。</li></ul> <p>IP hash</p> <ul><li>IP哈希。该方法只会作用于HTTP。使用客户端IP作为哈希输入。使用IPv4前3个字节或者整个IPv6作为输入。同样会考虑权重。可以为其中一个暂时无法服务的服务器标记<code>down</code>，将原本该请求至此的新请求被重新计算并转发到新的服务器实例上。启用指令为<code>ip_hash</code>。</li></ul> <h3 id="sticky-cookie-nginx-plus"><a href="#sticky-cookie-nginx-plus" class="header-anchor">#</a> Sticky Cookie（Nginx Plus）</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">upstream</span> backend <span class="token punctuation">{</span>
  <span class="token keyword">server</span> backend1<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
  <span class="token keyword">server</span> backend2<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
  sticky cookie
    		 affinity
         <span class="token keyword">expires</span><span class="token operator">=</span><span class="token number">1</span>h
         domain<span class="token operator">=</span><span class="token punctuation">.</span>example<span class="token punctuation">.</span>com
         httponly
         secure
         path<span class="token operator">=</span><span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Nginx Plus可以在客户端和服务器第一个请求中设置这个cookie，随后追踪这个cookie，确保接下来的请求都导向相同的服务器中。</p> <h3 id="sticky-learn-nginx-plus"><a href="#sticky-learn-nginx-plus" class="header-anchor">#</a> Sticky Learn（Nginx Plus）</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">upstream</span> backend <span class="token punctuation">{</span>
  <span class="token keyword">server</span> backend1<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">8080</span><span class="token punctuation">;</span>
  <span class="token keyword">server</span> backend2<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">8081</span><span class="token punctuation">;</span>
  
  sticky learn
         create<span class="token operator">=</span><span class="token variable">$upstream_cookie_cookiename</span>
         lookup<span class="token operator">=</span><span class="token variable">$cookie_cookiename</span>
         zone<span class="token operator">=</span>client_session<span class="token punctuation">:</span><span class="token number">2</span>m<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该示例告诉Nginx从相应头中查找和追踪名字为COOKIENAME的cookie，并且查找cookie相对应的session，该session存储与2MB大小的共享内存中。</p> <p>create告诉Nginx如何创建会话。</p> <p>lookup告诉Nginx如何搜索绘画。</p> <p>zone指定存储共享内存的名字和大小。</p> <p>上述变量都在HTTP模块中指定。</p> <h3 id="sticky-routing-nginx-plus"><a href="#sticky-routing-nginx-plus" class="header-anchor">#</a> Sticky Routing（Nginx Plus）</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">map</span> <span class="token variable">$cookie_jsessionid</span> <span class="token variable">$route_cookie</span> <span class="token punctuation">{</span>
  <span class="token operator">~</span><span class="token punctuation">.</span><span class="token operator">+</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">?</span>P<span class="token operator">&lt;</span>route<span class="token operator">&gt;</span>\w<span class="token operator">+</span><span class="token punctuation">)</span>$ <span class="token variable">$route</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">map</span> <span class="token variable">$request_uri</span> <span class="token variable">$route_uri</span> <span class="token punctuation">{</span>
  <span class="token operator">~</span>jsessionid<span class="token operator">=</span><span class="token punctuation">.</span><span class="token operator">+</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">?</span>P<span class="token operator">&lt;</span>route<span class="token operator">&gt;</span>\w<span class="token operator">+</span><span class="token punctuation">)</span>$ <span class="token variable">$route</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">upstream</span> backend <span class="token punctuation">{</span>
  <span class="token keyword">server</span> backend1<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com route<span class="token operator">=</span>a<span class="token punctuation">;</span>
  <span class="token keyword">server</span> backend2<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com route<span class="token operator">=</span>b<span class="token punctuation">;</span>
  
  sticky route <span class="token variable">$route_cookie</span> <span class="token variable">$route_uri</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>sticky route可以传递多个参数，第一个非空的参数作为路由依据。例如如果$route_cookie为空，$route_uri非空，则路由至backend2.example.com。</p> <h3 id="connection-draining-nginx-plus"><a href="#connection-draining-nginx-plus" class="header-anchor">#</a> Connection Draining（Nginx Plus）</h3> <p>可以通过Nginx Plus API控制Nginx不再向某个服务器发送新的连接。</p> <p>在删除session时，需要保证与该session有关的旧的为断开的连接还能正常进行，但是不在接受新的连接。</p> <h3 id="passive-health-checks"><a href="#passive-health-checks" class="header-anchor">#</a> Passive Health Checks</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">upstream</span> backend <span class="token punctuation">{</span>
  <span class="token keyword">server</span> backend1<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">1234</span> max_fails<span class="token operator">=</span><span class="token number">3</span> fail_timeout<span class="token operator">=</span><span class="token number">3</span>s<span class="token punctuation">;</span>
  <span class="token keyword">server</span> backend2<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">1234</span> max_fails<span class="token operator">=</span><span class="token number">3</span> fail_timeout<span class="token operator">=</span><span class="token number">3</span>s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Nginx默认开启健康检查。可用于HTTP、TCP和UDP。</p> <h3 id="active-health-checks-nginx-plus"><a href="#active-health-checks-nginx-plus" class="header-anchor">#</a> Active Health Checks（Nginx Plus）</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">http</span> <span class="token punctuation">{</span>
  <span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
      <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>backend<span class="token punctuation">;</span>
      health_check interval<span class="token operator">=</span><span class="token number">2</span>s
          fails<span class="token operator">=</span><span class="token number">2</span>
          passes<span class="token operator">=</span><span class="token number">5</span>
          uri<span class="token operator">=</span><span class="token operator">/</span>
          match<span class="token operator">=</span>welcome<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  match welcome <span class="token punctuation">{</span>
    status <span class="token number">200</span><span class="token punctuation">;</span>
    header Content<span class="token operator">-</span>Type <span class="token operator">=</span> text<span class="token operator">/</span>html<span class="token punctuation">;</span>
    body <span class="token operator">~</span> <span class="token string">&quot;Welcome to nginx!&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于HTTP，在location块中使用<code>health_check</code>指令。上述示例中，配置了每两秒对上游服务器发起URI为 ‘/’ 的HTTP请求，上游服务器连续通过5次请求则认为其是健康的，如果连续失败两次则认为其是不健康的。上游服务器的响应需要满足match块中的内容，即响应码为200，头部包含类型为text/html的Content-Type，响应体为“Welcome to nginx！”。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>stream <span class="token punctuation">{</span>
  <span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span> <span class="token number">1234</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_pass</span> stream_backend<span class="token punctuation">;</span>
    health_check interval<span class="token operator">=</span><span class="token number">10</span>s
        passes<span class="token operator">=</span><span class="token number">2</span>
        fails<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
    health_check_timeout <span class="token number">5</span>s<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>UDP、TCP和HTTP的区别在于TCP中参数没有uri，并且match块中只有<code>send</code>和<code>expect</code>两个指令，<code>send</code>是发送的数据，<code>expect</code>是响应的数据。</p> <h3 id="slow-start"><a href="#slow-start" class="header-anchor">#</a> Slow Start</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">upstream</span> <span class="token punctuation">{</span>
  zone backend <span class="token number">64</span>k<span class="token punctuation">;</span>
  
  <span class="token keyword">server</span> server1<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com slow_start<span class="token operator">=</span><span class="token number">20</span>s<span class="token punctuation">;</span>
  <span class="token keyword">server</span> server2<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com slow_start<span class="token operator">=</span><span class="token number">15</span>s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>慢启动可以控制上游服务器在启动的一定时间内接受的连接数。上游服务器启动时可能需要重启数据库等一系列操作，慢启动则可以保证其启动过程不会再次被大量请求淹没。例如上述server1服务器权重在20s时间内从0变到1。</p> <h2 id="traffic-management"><a href="#traffic-management" class="header-anchor">#</a> Traffic Management</h2> <h3 id="a-b-testing"><a href="#a-b-testing" class="header-anchor">#</a> A/B Testing</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">split_clients</span> <span class="token string">&quot;${remote_addr}AAA&quot;</span> <span class="token variable">$variant</span> <span class="token punctuation">{</span>
  <span class="token number">20.0</span><span class="token operator">%</span>  <span class="token string">&quot;backendv2&quot;</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>      <span class="token string">&quot;backednv1&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
  <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$variant</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>${remote_addr}AAA</code>将作为哈希的参数，计算出的值如果&lt;20%则<code>$variant</code>的值为backendv2，其余则为backendv1。使用该方法可以很方便的进行A/B测试。</p> <h3 id="using-the-geoip-module-and-database"><a href="#using-the-geoip-module-and-database" class="header-anchor">#</a> Using the GeoIP Module and Database</h3> <h3 id="restricting-access-based-on-country"><a href="#restricting-access-based-on-country" class="header-anchor">#</a> Restricting Access Based on Country</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">http</span> <span class="token punctuation">{</span>
  <span class="token keyword">map</span> <span class="token variable">$geoip_country_code</span> <span class="token variable">$country_access</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;US&quot;</span>    <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token string">&quot;RU&quot;</span>    <span class="token number">0</span><span class="token punctuation">;</span>
    default <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$country_access</span> <span class="token operator">=</span> <span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">403</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="finding-the-original-client"><a href="#finding-the-original-client" class="header-anchor">#</a> Finding the Original Client</h3></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.750feb0e.js" defer></script><script src="/assets/js/2.51f79b28.js" defer></script><script src="/assets/js/44.65ed8576.js" defer></script><script src="/assets/js/10.c677f95a.js" defer></script>
  </body>
</html>
