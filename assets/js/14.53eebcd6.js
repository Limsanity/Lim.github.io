(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{360:function(t,s,a){t.exports=a.p+"assets/img/1.83e00fbe.png"},361:function(t,s,a){t.exports=a.p+"assets/img/2.990e990f.png"},424:function(t,s,a){"use strict";a.r(s);var n=a(46),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"充分利用缓存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#充分利用缓存"}},[t._v("#")]),t._v(" 充分利用缓存")]),t._v(" "),n("p",[t._v("Docker的构建是分层的，一条指令一层。如果第n层发生了改动，第n层以后的缓存都会失效。大多数情况，判断缓存是否可用的方法是判断指令是否一致，对于COPY和ADD命令则会计算镜像内的文件和构建目录的校验。")]),t._v(" "),n("h2",{attrs:{id:"实践"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实践"}},[t._v("#")]),t._v(" 实践")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("mkdir hello"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("world "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" cd hello"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("world\nnpm init "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("y\nnpm i express\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// S index.js")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'express'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// E index.js")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// S Dockerfile")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("FROM")]),t._v(" node\n\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("WORKDIR")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("src\n\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COPY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("json "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("src"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("json\n\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("RUN")]),t._v(" cd "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("src "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" npm install\n\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COPY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("src\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// E Dockerfile")]),t._v("\n\ndocker build "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("t limsanity3"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("hello"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("world "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])])]),n("p",[t._v("完成第一构建之后，修改"),n("code",[t._v("index.js")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// S index.js")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'express'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello world'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// E index.js")]),t._v("\n\ndocker build "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("t limsanity3"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("hello"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("world "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])])]),n("p",[t._v("此时在terminal中的输出，可以看到构建过程利用了缓存：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(360),alt:""}})]),t._v(" "),n("p",[t._v("因此，如果我们把"),n("code",[t._v("package.json")]),t._v("和业务代码区分开来，只要没有引入新的npm包，前面的Step都可以利用cache。通常业务代码变动会比"),n("code",[t._v("package.json")]),t._v("大，因此编写Dockerfile时，要尽可能把变动较小的指令放到前面。")]),t._v(" "),n("p",[t._v("接下来验证第n层变动缓存发生变动，其后cache都不再生效的情况：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("npm i js"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cookie\n\ndocker build "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("t limsanity3"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("hello"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("world "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])])]),n("p",[n("img",{attrs:{src:a(361),alt:""}})]),t._v(" "),n("p",[t._v("使用npm安装新的包导致"),n("code",[t._v("package.json")]),t._v("内容发生变化，从Step 3开始，后面都不再使用cache，即便没有更新index.js。")]),t._v(" "),n("h3",{attrs:{id:"参考"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),n("p",[n("a",{attrs:{href:"https://blog.csdn.net/weixin_34404393/article/details/88598139",target:"_blank",rel:"noopener noreferrer"}},[t._v("利用构建缓存机制缩短Docker镜像构建时间"),n("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=e.exports}}]);