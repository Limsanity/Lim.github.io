(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{362:function(n,t,s){n.exports=s.p+"assets/img/3.f7b6221b.png"},425:function(n,t,s){"use strict";s.r(t);var a=s(46),e=Object(a.a)({},(function(){var n=this,t=n.$createElement,a=n._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[a("h1",{attrs:{id:"多阶段构建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#多阶段构建"}},[n._v("#")]),n._v(" 多阶段构建")]),n._v(" "),a("p",[n._v("多阶段构建是Docker 17.05的新特性，使得单个Dockerfile中可以执行多个阶段的构建，构建过程更容易维护。")]),n._v(" "),a("h2",{attrs:{id:"实践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实践"}},[n._v("#")]),n._v(" 实践")]),n._v(" "),a("p",[n._v("构建一个前端镜像通常需要两个步骤：在node环境下安装依赖包并完成build过程、将build出来的dist文件复制到nginx环境下container中制作成镜像。")]),n._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[n._v("vue create docker-mutistage\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[n._v("cd")]),n._v(" docker-mutistage\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# S .dockerignore copy from .gitignore")]),n._v("\n.DS_Store\nnode_modules\n/dist\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# local env files")]),n._v("\n.env.local\n.env.*.local\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# Log files")]),n._v("\nnpm-debug.log*\nyarn-debug.log*\nyarn-error.log*\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# Editor directories and files")]),n._v("\n.idea\n.vscode\n*.suo\n*.ntvs*\n*.njsproj\n*.sln\n*.sw?\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# E .dockerignore")]),n._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# S Dockerfile")]),n._v("\nFROM node as builder\n\nWORKDIR /app\n\nCOPY package.json /app/package.json\nCOPY package-lock.json /app/package-lock.json\n\nRUN "),a("span",{pre:!0,attrs:{class:"token function"}},[n._v("npm")]),n._v(" ci\n\nCOPY "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[n._v(".")]),n._v(" /app\n\nRUN "),a("span",{pre:!0,attrs:{class:"token function"}},[n._v("npm")]),n._v(" run build\n\nFROM nginx:alpine\n\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\nCOPY --from"),a("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v("builder /app/dist /usr/share/nginx/html/\n\nEXPOSE "),a("span",{pre:!0,attrs:{class:"token number"}},[n._v("80")]),n._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# E Dockerfile")]),n._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# S nginx.conf")]),n._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# 开启gzip")]),n._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[n._v("gzip")]),n._v(" on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# 启用gzip压缩的最小文件，小于设置值的文件将不会压缩")]),n._v("\ngzip_min_length 1k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# gzip 压缩级别，1-10，数字越大压缩的越好，也越占用CPU时间，后面会有详细说明")]),n._v("\ngzip_comp_level "),a("span",{pre:!0,attrs:{class:"token number"}},[n._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# 进行压缩的文件类型。javascript有多种形式。其中的值可以在 mime.types 文件中找到。不对图片做gzip")]),n._v("\ngzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# 是否在http header中添加Vary: Accept-Encoding，建议开启")]),n._v("\ngzip_vary on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# 禁用IE 6 gzip")]),n._v("\ngzip_disable "),a("span",{pre:!0,attrs:{class:"token string"}},[n._v('"MSIE [1-6]\\."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\nserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# 监听80端口")]),n._v("\n  listen       "),a("span",{pre:!0,attrs:{class:"token number"}},[n._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n  server_name  localhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# 开启零拷贝")]),n._v("\n  sendfile     on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n  location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n    root /usr/share/nginx/html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    try_files "),a("span",{pre:!0,attrs:{class:"token variable"}},[n._v("$uri")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[n._v("$uri")]),n._v("/ /index.html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# E nginx.conf")]),n._v("\n\ndocker build -t limsanity3/mutistage "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[n._v(".")]),n._v("\n")])])]),a("p",[n._v("可以看到在Dockerfile文件中有两个From，指定两个阶段的工作。build阶段中因为要使用npm ci，所以要复制package-lock.json，否则会报错。npm ci安装包是锁版本的，如果使用npm install则会有一个请求包版本的过程，降低安装速度。nginx使用了alpine镜像，alpine镜像用的是Alpine Linux内核，比latest版本的ubuntu内核小的多：")]),n._v(" "),a("p",[a("img",{attrs:{src:s(362),alt:""}})])])}),[],!1,null,null,null);t.default=e.exports}}]);